---
- name: Create the OpenStack project
  os_project:
    auth:
      auth_url: "{{ os_auth_url }}"
      username: "{{ os_username }}"
      password: "{{ os_password }}"
      project_name: "{{ os_project_name }}"
    state: "{{ region_info.state | default('present') }}"
    name: "{{ region_info.project }}"
    description: "{{ region_info.description | default(omit) }}"
    domain_id: "{{ region_info.domain_id | default(omit) }}"
    enabled: True
    validate_certs: False
  tags:
    - cloud
    - os
    
- name: Add users to the OpenStack project
  os_user_role:
    auth:
      auth_url: "{{ os_auth_url }}"
      username: "{{ os_username }}"
      password: "{{ os_password }}"
      project_name: "{{ os_project_name }}"      
    user: "{{ tenant_user_item }}"
    role: _member_
    project: "{{ region_info.project }}"
    validate_certs: False
  with_items: "{{ region_info.users | default([]) }}"
  loop_control:
    loop_var: tenant_user_item
  tags:
    - cloud
    - os
    
- name: Create the OpenStack tenant networks
  os_network:
    auth:
      auth_url: "{{ os_auth_url }}"
      username: "{{ os_username }}"
      password: "{{ os_password }}"
      project_name: "{{ os_project_name }}"
    state: present
    shared: false
    provider_network_type: vlan
    name: "{{ network_list_item.name }}"
    external: false
    project: "{{ region_info.project }}"
    validate_certs: False
  register: tenant_network
  with_items: "{{ region_info.networks | default([]) }}"
  loop_control:
    loop_var: network_list_item
  tags:
    - cloud
    - os
    
- set_fact:
    vlan_id: "{{ tenant_network.results[0].network['provider:segmentation_id'] }}"
    
- name: Create the OpenStack tenant subnets
  os_subnet:
    auth:
      auth_url: "{{ os_auth_url }}"
      username: "{{ os_username }}"
      password: "{{ os_password }}"
      project_name: "{{ os_project_name }}"
    state: present
    network_name: "{{ network_list_item.name }}"
    name: "{{ network_list_item.name | default(network_list_item.cidr) }}"
    cidr: "{{ network_list_item.cidr }}"
    dns_nameservers: "{{ network_list_item.dns_server_list | default([]) }}"
    validate_certs: False
  register: tenant_subnet
  with_items: "{{ region_info.networks | default([]) }}"
  loop_control:
    loop_var: network_list_item
  tags:
    - cloud
    - os